---
title: 内存管理策略
description: Direct3D 12 的内存管理器无法获取快速与技术支持、 UMA 或离散的 (非 UMA) 适配器，以及使用 GPU 适配器之间的体系结构差异相当大范围的所有不同层非常复杂。Direct3D 12 内存管理，在本部分中所述的建议的策略是 \ 0034; 进行分类、 预算和流式传输 \ 0034;。
ms.assetid: BC9894F7-D496-46F2-A5C3-C7CA31FD4BA8
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a7055078aa6a20664fb20e589e1fec50a61e00e8
ms.sourcegitcommit: 1fbe7572f20938331e9c9bd6cccd098fa1c6054d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/27/2019
ms.locfileid: "66224041"
---
# <a name="memory-management-strategies"></a>内存管理策略

Direct3D 12 的内存管理器无法获取快速与技术支持、 UMA 或离散的 (非 UMA) 适配器，以及使用 GPU 适配器之间的体系结构差异相当大范围的所有不同层非常复杂。

Direct3D 12 内存管理，在本部分中所述的建议的策略是"分类、 预算和流式传输"。

-   [资源类型](#resource-types)
-   [内存消耗](#memory-budget)
-   [分类策略](#classification-strategy)
-   [相关的主题](#related-topics)

## <a name="resource-types"></a>资源类型

"已提交资源"（创建在托管的物理内存中初始化这两个虚拟和物理地址空间） 的基本概念问世以来 Direct3D 9，但虚拟寻址 (VA) 和物理寻址可以 teased 相隔到 Direct3D 12 中允许应用来仔细管理物理内存。

除了已提交的资源，Direct3D 12 的堆构造使两个其他类型的资源:"放置"和"保留"。 在 Direct3D 11 中的"保留"资源称为"平铺资源"。

保留的资源不同，从放置资源，保留的资源具有其自己唯一的 GPU 虚拟地址空间。 这允许分配大量的预先 VA 空间，然后启用映射的某些部分堆更高版本，VA 页并在应用程序将重新配置动态的排列方式。 VA 空间连续的并且可以稀疏映射到。

保留的资源可以进行如引用具有 API 调用的堆中的区域[ **UpdateTileMappings** ](/windows/desktop/api/d3d12/nf-d3d12-id3d12commandqueue-updatetilemappings)和他们可以通过驻留应用程序通过更新动态页表。 当 VA 范围映射为 NULL 或非驻留堆时，资源的该部分被视为非驻留。 当 VA 范围映射到某一常驻堆时，该部分的资源被视为驻留。 堆是驻留在创建时。

放置的资源是堆的多更简单的设计，在只需指向特定的区域 （例如，纹理 5mb 堆中的 1 Mb 区域） 的指针。 别名屏障启用重叠放置资源的使用 (请参阅[ **CreatePlacedResource** ](/windows/desktop/api/D3D12/nf-d3d12-id3d12device-createplacedresource)并[ **ResourceBarrier**](/windows/desktop/api/d3d12/nf-d3d12-id3d12graphicscommandlist-resourcebarrier))。

保留的资源上不可用 Direct3D 12 的所有硬件，并放置的资源是合理的回退，尽管放置的资源必须是连续的和不能为部分驻留。

## <a name="memory-budget"></a>内存消耗

在 Direct3D 12 中分配堆时将创建的物理内存方面的已提交的资源。 Direct3D 12 （视频和系统内存之间进行选择） 中提供了更明确的内存段选择。 UMA 适配器只能有一个内存段，系统内存。

Gpu 不支持分页错误，因此开发人员必须是有意识的执行不通过提交，尤其是对系统声称的仅有 1 gb 的系统内存。 如果应用程序存在于提交，操作系统使用粗粒度的物理内存的需求，它们通过计划的进程。 计划程序将冻结前台进程和实质上是页面的一些以页在想要运行的后台进程。 可用物理内存可能千差万别，具体取决于用户在后台 （如运行浏览器，或观看视频） 中执行的操作。

内存消耗的 API 是[ **QueryVideoMemoryInfo**](https://msdn.microsoft.com/library/windows/desktop/dn933223)。 视频离散适配器"local"为内存中，"非本地"是系统内存。 对于 UMA 非本地适配器始终是零。 一个设计问题是您的引擎是否将管理预算或只是本地的预算。 管理仅本地预算更简单，但有一些需要注意的问题;例如，假设有为 1 Gb 的最大本地预算，则所有的堆将来自该 1gb UMA 系统中并且没有任何溢出到系统内存 （很明显，因为没有 none）。

由于 Direct3D11 管理应用程序的内存，实质上是将出页未使用的资源。

选择最合适的资源维度。 请考虑资源的大小是否适合于应用程序实际运行中的情况。 在窗口中或与屏幕分辨率为 800 x 600，某些用户可能会运行应用程序。

## <a name="classification-strategy"></a>分类策略

为了管理在内存绑定方案中有效的资源，请考虑分类为以下资源：



| 分类      | 示例                                                                                         | 对象和 API 功能                                                                                           | 管理说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|---------------------|--------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 严重            | 游戏 UI                                                                                          | 命令分配器，命令队列堆查询堆，资源和资源。                                      | 这些元素应该放在非-可分页/始终提交的内存。<br/>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 缩放/可选    | 特定于级别的模型和纹理，交换链，天空框中，第一人称播放机字符模型 | 资源和堆。 提交的资源，但还放置和保留资源可能起作用也很好用。          | 将集成到呈现算法的内存驻留预算。 选择适当级别的可用详细信息，重新评估小于一次每个帧。 技术包括使用可变的资源和交换链缩放。<br/>                                                                                                                                                                                                                                                                                                                                                 |
| 重新使用的资源   | 卷影缓冲区，延迟呈现资源、 后处理照明数据缓存的资源    | 资源和堆。 重叠放置在堆上的资源和别名屏障。                                  | 重复使用大型资源，或堆中帧的区域精简有关整个帧的要求。 使用内部帧内存重复使用的技术。 在 Direct3D 11 中，应用程序可以重复使用相同的类型和尺寸可能足够大的资源仅使用。 Direct3D 12 堆允许重叠的多更简单和更高的重复使用的资源。<br/>                                                                                                                                                                                                                              |
| 流式处理资源 | 地形、 打开世界纹理和几何图形                                                        | 资源和堆。 自由线程的创建、 后台 CPU 线程和后台复制命令队列和列表。 | 部分驻留，通常根据 （使用视图截锥或基于距离的评估版） 的可见性和重新评估驻留需要每一帧。<br/> 当 GPU 适配器支持在堆中的保留的资源，使用每个磁贴部分驻留管理和框架间重复使用的方法才可用。<br/> 使用使用间帧内存重复使用的技术，可以是分部的子资源驻留来完成，但最好在较低。 带有堆的放置的资源应启用更快地回收，但已提交的资源可以用作回退。<br/> |



 

更多应用程序移向流式处理资源的大部分工作，他们将会越利用放置并且保留资源，这将最大限度地重复使用这些四个分类之间显示的内存。 更多应用程序流式传输，越是预算和确定优先级的带宽。

通常使用 Direct3D 12 图形引擎需要遵循更多样的动态预算，比过去更严格地执行该操作。 最佳的应用程序将查找所有四个类别到提供给该过程中，扩展了游戏界面背景的移动应用中为全屏显示离散预算的预算。 但是，许多应用程序将开始使用太多的关键任务级别类型的资源可能并非易事。 Direct3D 11 启用以匿名方式创建，并且占用而不会影响性能的关键状态的资源。 但是，有关 Direct3D 12 中，开发人员努力必须搜索整个其引擎和中间件的随机创建资源，并重新将其分配给其他类别之一。

其他问题方面就是中间件组件、 用户控件和内部帧流式处理。 中间件组件可能不会公开与预算，也不具有进行紧密协作。 中间件组件可能无法将功能公开为呈现技术;并且应用程序可能依赖于公开中间件和引擎设置。 开发人员可以依赖于 Direct3D 11 完成分页，获得正确的帧速率。 在某些情况下，Direct3D 11 应用程序可能具有已分页资源内容 in 和 out 每个帧的值。它会导致用户的可接受的帧速率。 大多数引擎仅数据流式传输资源作为后台活动，有不正常回退到优先级较高的帧内流式处理。 询问引擎来实现将逐渐销蚀一些这些公司正在寻求通过将移动到 Direct3D 12 的 CPU 开销提升。 引擎开发人员可以考虑其帧分解为多个阶段提供更多机会重用资源;和可能适用于中间件供应商支持放置的资源和堆有关内部帧内存重新使用。

## <a name="related-topics"></a>相关主题

<dl> <dt>

[**CreateCommittedResource**](/windows/desktop/api/D3D12/nf-d3d12-id3d12device-createcommittedresource)
</dt> <dt>

[**CreateReservedResource**](/windows/desktop/api/D3D12/nf-d3d12-id3d12device-createreservedresource)
</dt> <dt>

[Direct3D 12 的编程指南](directx-12-programming-guide.md)
</dt> <dt>

[内存管理](memory-management.md)
</dt> <dt>

[资源绑定](resource-binding.md)
</dt> </dl>

 

 





